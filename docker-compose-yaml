version: '3.8'

volumes:
  vol_pihole:
    driver: local
    driver_opts:
      type: none
      device: /opt/docker/run/pihole/etc-pihole
      o: bind
  vol_dnsmasq:
    driver: local
    driver_opts:
      type: none
      device: /opt/docker/run/pihole/etc-dnsmasq.d
      o: bind
  vol_portainer:
    driver: local
    driver_opts:
      type: none
      device: /opt/docker/run/portainer/data
      o: bind

services:
  pihole:
    container_name: pihole
    image: pihole/pihole:latest
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
      - vol_pihole:/etc/pihole/
      - vol_dnsmasq:/etc/dnsmasq.d/
    cap_add:
      - NET_ADMIN
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  dns_1:
    container_name: dns_1
    image: qmcgaw/dns
    networks:
      dns_net:
        aliases:
          - dns
    environment:
      - VERBOSITY=1
      - VERBOSITY_DETAILS=0
      - BLOCK_MALICIOUS=on
      - BLOCK_SURVEILLANCE=on
      - BLOCK_ADS=off
      - BLOCK_IPS=
      - BLOCK_HOSTNAMES=
      - UNBLOCK=
      - PROVIDERS=cloudflare,quad9
      - UPDATE_PERIOD=24h
    ports:
      - "8053:53/tcp"
      - "8053:53/udp"
    restart: always

  dns_2:
    container_name: dns_2
    image: qmcgaw/dns
    networks:
      dns_net:
        aliases:
          - dns
    environment:
      - VERBOSITY=1
      - VERBOSITY_DETAILS=0
      - BLOCK_MALICIOUS=on
      - BLOCK_SURVEILLANCE=on
      - BLOCK_ADS=off
      - BLOCK_IPS=
      - BLOCK_HOSTNAMES=
      - UNBLOCK=
      - PROVIDERS=cloudflare,quad9
      - UPDATE_PERIOD=24h
    ports:
      - "9053:53/tcp"
      - "9053:53/udp"
    restart: always

  watchtower:
    container_name: watchtower
    image: containrrr/watchtower:latest
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Australia/Adelaide
      - UMASK_SET=022 #optional
      - WATCHTOWER_CLEANUP=true
    restart: always

  portainer:
    container_name: portainer
    image: portainer/portainer-ce:latest
    command: -H unix:///var/run/docker.sock
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Australia/Adelaide
      - UMASK_SET=022 #optional
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/timezone:/etc/timezone:ro
      - vol_portainer:/data
    ports:
      - '9000:9000'
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  dns_net:
    ipam:
      config:
        - subnet: 172.28.5.0/24

  pihole_net:
    ipam:
      config:
        - subnet: 172.29.5.0/24

